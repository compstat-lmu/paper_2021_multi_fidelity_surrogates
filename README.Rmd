---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```


# Surrogates for Multi-Fidelity Problems

This package contains several surrogates that approximate the hyperparameter response surface for several interesting machine learing algorithms across several tasks.


## Overview


```{r, eval = FALSE, echo=FALSE}
library(mlr3misc)
library(mfsurrogates)
library(data.table)
dt = data.frame(
  instance = c("nb301", "lcbench", "rbv2_ranger", "rbv2_rpart", "rbv2_aknn",
               "rbv2_glmnet", "rbv2_ranger", "rbv2_xgboost", "rbv2_super", "fcnet", "task_set"),
  space = c("Cat+Dep", "Mix", "Mix+Dep", "Mix", "Mix", "Mix", "Mix+Dep",
            "Mix+Dep","Mix+Dep", "Mix", "Num"),
  n_dims = c(34L, 7L, 6L, 5L, 6L, 3L, 8L, 14L, 34L, 11L, 9L),
  n_targets = c("2:perf(1)+rt", "6:perf(5)+rt","6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt", "6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt", "4:perf(2)+rt+ ms", "4:perf(4)"),
  fidelity = c("epochs", "epochs", "frac+repls", "frac+repls", "frac+repls", "frac+repls", "frac+repls", "frac+repls", "frac+repls", "epochs+repls", "epochs+repls"),
  n_problems = c(1L, 35L, 96L, 101L, 99L, 98L, 114L, 109L, 89L, 4L, 20L),
  status = "ready"
)

metrics = data.table(do.call("rbind",
  map(dt$instance, function(x) {
  x = fread(paste0(cfgs(x, workdir=workdir)$subdir, "surrogate_test_metrics.csv"))
  x = t(apply(keep(x, is.numeric), 2, range))[c("rsq", "roh"),]
  paste0(round(x[,1], 2), "-", round(x[,2],2))
  })
))
colnames(metrics) = c("Rsq", "Rho")

knitr::kable(cbind(dt, metrics))
```


|instance     |space   | n_dims|n_targets        |fidelity     | n_problems|status |Rsq       |Rho        |
|:------------|:-------|------:|:----------------|:------------|----------:|:------|:---------|:----------|
|nb301        |Cat+Dep |     34|2:perf(1)+rt     |epochs       |          1|ready  |0.6-0.99  |0.91-0.99  |
|lcbench      |Mix     |      7|6:perf(5)+rt     |epochs       |         35|ready  |0.95-1    |0.94-1     |
|rbv2_ranger  |Mix+Dep |      6|6:perf(4)+rt+pt  |frac+repls   |         96|ready  |0.4-0.98  |0.64-0.99  |
|rbv2_rpart   |Mix     |      5|6:perf(4)+rt+pt  |frac+repls   |        101|ready  |0-0.99    |0.02-1     |
|rbv2_aknn    |Mix     |      6|6:perf(4)+rt+pt  |frac+repls   |         99|ready  |0.4-0.97  |0.63-0.98  |
|rbv2_glmnet  |Mix     |      3|6:perf(4)+rt+pt  |frac+repls   |         98|ready  |0.02-0.98 |-0.15-0.99 |
|rbv2_ranger  |Mix+Dep |      8|6:perf(4)+rt+pt  |frac+repls   |        114|ready  |0.4-0.98  |0.64-0.99  |
|rbv2_xgboost |Mix+Dep |     14|6:perf(4)+rt+pt  |frac+repls   |        109|ready  |0.53-0.98 |0.72-0.99  |
|rbv2_super   |Mix+Dep |     34|6:perf(4)+rt+pt  |frac+repls   |         89|ready  |0.65-0.97 |0.81-0.99  |
|fcnet        |Mix     |     11|4:perf(2)+rt+ ms |epochs+repls |          4|ready  |0.77-1    |0.97-1     |
|task_set     |Num     |      9|4:perf(4)        |epochs+repls |         20|ready  |0.12-0.15 |0.35-0.39  |


where for **n_targets** (#number):

- perf = performance measure
- ms = model_size
- rt = runtime
- pt = predicttime

For more information either look directly into the [code](https://github.com/compstat-lmu/paper_2021_multi_fidelity_surrogates/blob/main/R/BenchmarkConfigs.R) or use the object's printers via `cfgs("...")`.

Toy test functions:

```{r, echo=FALSE}
dt = data.frame(
  instance = c("Branin", "Shekel", "ZDT6"),
  space = c("Num", "Num", "Num"),
  n_dims = c(2L, 4L, 10L),
  n_targets = c("1:y", "1:y", "2:F1+F2"),
  fidelity = c("fidelity", "fidelity", "fidelity"),
  n_problems = c(1L, 1L, 1L),
  status = c("ready", "ready", "needs discussion")
)
knitr::kable(dt)
```


## NASBench-301

We first load the config:

```{r,eval=FALSE}
library(checkmate)
library(paradox)
library(mfsurrogates)
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("nb301", workdir = workdir)
cfg$setup()  # automatic download of files; necessary if you didn't download manually
cfg
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
library("bbotk")
library("data.table")
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 2L)
)
opt("random_search")$optimize(ins)
```

Since NASBench is only trained on `CIFAR10`, we do not need to set a specific `task_id` here.

## LCBench

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("lcbench", workdir = workdir)
cfg$setup()
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

### Subsetting to a specific task

In practice, we need to subset to a `task_id` if we want to tune
on a specific task.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(task = "126025"),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

A list of available `task_id`s can be obtained from the `param_set`:

```{r, eval=FALSE}
cfg$param_set$params$OpenML_task_id$levels
# or using the active binding across all configs:
cfg$task_levels
```

If the configuration only has $1$ task, `NULL` is returned.

## Branin

We first load the config:

```{r,eval=FALSE}
cfg = cfgs("branin")
#cfg$plot()  # or method = "rgl"
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## Shekel

We first load the config:

```{r,eval=FALSE}
cfg = cfgs("shekel")
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceSingleCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```


## ZDT6

We first load the config:

```{r,eval=FALSE}
cfg = cfgs("zdt6")
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```



## RandomBotv2

All rbv2 have been at least partially evaluated on the same `OpenML` tasks.
In order to provide a consistent set to evaluate on, the set where all algorithms had a sufficient amount of evaluations is available as `rbv2_test_tasks`.
All other task's in the respective config's `param_set` also have sufficient evaluations, but not consistently across all datasets and are therefore not included in the set.

```{r}
rbv2_test_tasks
```

## RandomBotv2 - svm

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_svm", workdir = workdir)
cfg$setup()
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

Example to select target variables and a task:

```{r,eval=FALSE}
objective = cfg$get_objective(task = "3", target_variables = c("perf.mmce", "traintime"))
objective$codomain
objective$constants
```

## RandomBotv2 - rpart

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_rpart", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## RandomBotv2 - aknn

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_aknn", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## RandomBotv2 - glmnet

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_glmnet", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## RandomBotv2 - ranger

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_ranger", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## RandomBotv2 - xgboost

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_xgboost", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## RandomBotv2 - super

The **super** learner is a learner that is parametrized as a choice over all available randombot base learners.
It has a highly hierarchical, $37$ dimensional parameter space that includes the configurations of all baselearners.


We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_super", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## FCNet

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("fcnet", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

## Overview

```{r,echo=FALSE}
perfs = rbindlist(map(cfgs()$keys(), function(k) {
  sdir = cfgs(k, workdir=workdir)$subdir
  if (!is.null(sdir)) {
     file = paste0(sdir, "surrogate_test_metrics.csv")
     fread(file)[, problem := k]
  }
}), fill=TRUE)
perfs[, grp := NULL]
knitr::kable(perfs[, c(6,1,2:5)])
```

|variable               |grp    |         rsq|        roh|       ktau|       mae|problem      |
|:----------------------|:------|-----------:|----------:|----------:|---------:|:------------|
|valid_loss             |full   |   0.7697238|  0.9735305|  0.8929699| 0.0208658|fcnet        |
|valid_mse              |full   |   0.8083662|  0.9725184|  0.8794825| 0.0185726|fcnet        |
|runtime                |full   |   0.9819679|  0.9991038|  0.9759359| 0.0170928|fcnet        |
|n_params               |full   |   0.9999258|  0.9996677|  0.9897761| 0.0015926|fcnet        |
|val_accuracy           |NA     |   0.9820286|  0.9915597|  0.9416426| 0.0135329|lcbench      |
|val_cross_entropy      |NA     |   0.9539423|  0.9727594|  0.8721939| 0.0016128|lcbench      |
|val_balanced_accuracy  |NA     |   0.9935297|  0.9953752|  0.9528810| 0.0106631|lcbench      |
|test_cross_entropy     |NA     |   0.9996986|  0.9936223|  0.9481520| 0.0021353|lcbench      |
|test_balanced_accuracy |NA     |   0.9940930|  0.9954836|  0.9553707| 0.0094280|lcbench      |
|time                   |NA     |   0.9776387|  0.9351182|  0.7851692| 0.0006790|lcbench      |
|val_accuracy           |NA     |   0.9865599|  0.9908638|  0.9212181| 0.0076705|nb301        |
|runtime                |NA     |   0.6047955|  0.9114967|  0.7685445| 0.0647477|nb301        |
|mmce                   |full   |   0.1117883|  0.7685703|  0.5937734| 0.1525729|rbv2_aknn    |
|f1                     |full   |   0.5032126|  0.8434363|  0.6572206| 0.1521988|rbv2_aknn    |
|auc                    |full   |   0.4469609|  0.8472739|  0.6627239| 0.1515917|rbv2_aknn    |
|logloss                |full   |   0.6224792|  0.7932935|  0.6078717| 0.0378088|rbv2_aknn    |
|timetrain              |full   | -16.0618394|  0.4976219|  0.3184698| 0.0028567|rbv2_aknn    |
|timepredict            |full   |   0.6898986|  0.6878958|  0.5125654| 0.0026647|rbv2_aknn    |
|mmce                   |_full_ |   0.2393465|  0.8067632|  0.6362529| 0.1424844|rbv2_glmnet  |
|f1                     |_full_ |  -6.5400533|  0.8012386|  0.6083145| 0.2153901|rbv2_glmnet  |
|auc                    |_full_ |  -0.7721788|  0.8234898|  0.6753602| 0.1912665|rbv2_glmnet  |
|logloss                |_full_ |  -0.0786129|  0.6106523|  0.4977549| 0.0258054|rbv2_glmnet  |
|timetrain              |_full_ |  -0.5208908|  0.5451177|  0.3539175| 0.0001349|rbv2_glmnet  |
|timepredict            |_full_ |  -4.5683053| -0.1540826| -0.0853480| 0.0710835|rbv2_glmnet  |
|mmce                   |_full_ |   0.3630743|  0.8198008|  0.6236626| 0.1087079|rbv2_ranger  |
|f1                     |_full_ |  -6.6858855|  0.8277801|  0.6307690| 0.1879499|rbv2_ranger  |
|auc                    |_full_ |  -2.8160715|  0.8413821|  0.6228295| 0.1869689|rbv2_ranger  |
|logloss                |_full_ |  -0.2783422|  0.4949336|  0.3653387| 0.0592265|rbv2_ranger  |
|timetrain              |_full_ |  -1.8119443|  0.5677335|  0.3975724| 0.0001728|rbv2_ranger  |
|timepredict            |_full_ |   0.5713114|  0.8573550|  0.6687513| 0.0022913|rbv2_ranger  |
|mmce                   |full   |   0.2800001|  0.8189137|  0.6309773| 0.1468973|rbv2_rpart   |
|f1                     |full   |   0.4426501|  0.8354008|  0.6325244| 0.1800363|rbv2_rpart   |
|auc                    |full   |   0.4271623|  0.8490347|  0.6501655| 0.1505240|rbv2_rpart   |
|logloss                |full   |   0.4298694|  0.8081368|  0.6015902| 0.0136049|rbv2_rpart   |
|timetrain              |full   | -15.6148295|  0.5530686|  0.3733640| 0.0048202|rbv2_rpart   |
|timepredict            |full   |   0.6771890|  0.6688500|  0.4917206| 0.0091435|rbv2_rpart   |
|mmce                   |_full_ |   0.7994528|  0.9516257|  0.8381165| 0.0750410|rbv2_super   |
|f1                     |_full_ |  -0.3619825|  0.8522022|  0.6874386| 0.0944816|rbv2_super   |
|auc                    |_full_ |   0.3711350|  0.8890996|  0.7172906| 0.0873027|rbv2_super   |
|logloss                |_full_ |   0.4350618|  0.8976683|  0.7090452| 0.0061148|rbv2_super   |
|timetrain              |_full_ |   0.4658050|  0.7908573|  0.6058155| 0.0000953|rbv2_super   |
|timepredict            |_full_ |   0.2063452|  0.7938050|  0.5799083| 0.0059618|rbv2_super   |
|mmce                   |_full_ |   0.4050524|  0.8629066|  0.7050543| 0.1412340|rbv2_svm     |
|f1                     |_full_ |  -2.7843968|  0.8141841|  0.6304430| 0.1634336|rbv2_svm     |
|auc                    |_full_ |  -0.7507778|  0.8513387|  0.6721488| 0.1488954|rbv2_svm     |
|logloss                |_full_ |  -0.0944788|  0.6295576|  0.4862044| 0.0482893|rbv2_svm     |
|timetrain              |_full_ |  -0.4424127|  0.6684094|  0.5130903| 0.0001493|rbv2_svm     |
|timepredict            |_full_ |  -0.2054601|  0.3794061|  0.2410893| 0.0095283|rbv2_svm     |
|mmce                   |full   |   0.7369535|  0.9427799|  0.8195378| 0.0875441|rbv2_xgboost |
|f1                     |full   |   0.8619454|  0.8913387|  0.7260556| 0.0825083|rbv2_xgboost |
|auc                    |full   |   0.8536695|  0.9068748|  0.7501761| 0.0755600|rbv2_xgboost |
|logloss                |full   |   0.7171367|  0.9073084|  0.7547382| 0.0079560|rbv2_xgboost |
|timetrain              |full   |  -2.6803552|  0.6852937|  0.5370234| 0.0029079|rbv2_xgboost |
|timepredict            |full   |   0.7993552|  0.7867625|  0.6114857| 0.0052632|rbv2_xgboost |
|train                  |full   | -44.2719269| -0.0308623| -0.0552205| 0.4378289|task_set     |
|valid1                 |full   | -68.2954432|  0.0363588|  0.0007753| 0.5433312|task_set     |
|valid2                 |full   | -66.5712313|  0.0328444| -0.0072158| 0.5414447|task_set     |
|test                   |full   | -65.4814749|  0.0367477| -0.0360162| 0.5392328|task_set     |
>>>>>>> deaa82311a67d789871eaf5c5e12ccff0992547e
