---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```


# Surrogates for Multi-Fidelity Problems

This package contains several surrogates that approximate the hyperparameter response surface for several interesting machine learing algorithms across several tasks.


## Overview

```{r, echo=FALSE}
dt = data.frame(
  instance = c("NB301", "LCBench", "RBv2SVM", "RBv2rpart", "RBv2aknn",
               "RBv2glmnet", "RBv2ranger", "RBv2xgboost", "RBv2super" "FCNet", "TaskSet"),
  space = c("Cat+Dep", "Mix", "Mix+Dep", "Mix", "Mix", "Mix", "Mix+Dep",
            "Mix+Dep","Mix+Dep", "Mix", "Num"),
  ndims = c(34L, 7L, 7L, 5L, 6L, 3L, 9L, 14L, 36L, 11L, 9L),
  ntargets = c("2:perf+rt", "6:perf(5)+rt","6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt", "6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt","6:perf(4)+rt+pt", "perf(2)+rt+ ms", "4:perf(4)"),
  fidelity = c("epochs", "epoch", "frac+repls", "frac+repls", "frac+repls", "frac+repls", "fract+repls", "frac+repls", "frac+repls", "epochs+repls", "epochs+repls"),
  n_problems = c(1L, 35L, 96L, 101L, 99L, 98L, 114L, 109L, 89L, 4L, 20L),
  "$R^2$" = c(0.9866, 0.9820, NA, NA, NA, NA, NA, NA, NA, 0.769, NA),
  status = c("ready", "ready", "-", "-", "-", "-", "-", "-", "-", "-", "ready", "-")
)
knitr::kable(dt)
```

where for **ntargets** (#number):
- perf = performance measure
- ms = model_size
- rt = runtime
- pt = predicttime

For more information either look directly into the [code](https://github.com/compstat-lmu/paper_2021_multi_fidelity_surrogates/blob/main/R/BenchmarkConfigs.R) or use the object's printers via `cfgs("...")`.

Toy test functions:

```{r, echo=FALSE}
dt = data.frame(
  instance = c("Branin", "Shekel"),
  space = c("Num", "Num"),
  n_dims = c(2L, 4L),
  n_targets = c(1L, 1L),
  fidelity = c("fidelity", "fidelity"),
  n_problems = c(1L, 1L)
)
knitr::kable(dt)
```

## NASBench-301

We first load the config:

```{r,eval=FALSE}
library(checkmate)
library(paradox)
library(mfsurrogates)
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("nb301", workdir = workdir)
cfg$setup()  # automatic download of files; necessary if you didn't download manually
cfg
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
library("bbotk")
library("data.table")
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 2L)
)
opt("random_search")$optimize(ins)
```

Since NASBench is only trained on `CIFAR10`, we do not need to set a specific `task_id` here.

## LCBench

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("lcbench", workdir = workdir)
cfg$setup()
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

### Subsetting to a specific task

In practice, we need to subset to a `task_id` if we want to tune
on a specific task.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(task = "126025"),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```

A list of available `task_id`s can be obtained from the `param_set`:

```{r, eval=FALSE}
cfg$param_set$params$OpenML_task_id$levels
```

## Branin

We first load the config:

```{r,eval=FALSE}
cfg = cfgs("branin")
#cfg$plot()  # or method = "rgl"
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## Shekel

We first load the config:

```{r,eval=FALSE}
cfg = cfgs("shekel")
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceSingleCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - svm

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_svm", workdir = workdir)
cfg$setup()
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

Example to select target variables and a task:

```{r,eval=FALSE}
objective = cfg$get_objective(task = "3", target_variables = c("perf.mmce", "traintime"))
objective$codomain
objective$constants
```

## RandomBotv2 - rpart

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_rpart", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - aknn

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_aknn", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - glmnet

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_glmnet", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - ranger

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_ranger", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - xgboost

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_xgboost", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## RandomBotv2 - super

The **super** learner is a learner that is parametrized as a choice over all available randombot base learners.
It has a highly hierarchical, $41$ dimensional parameter space that includes the configurations of all baselearners.


We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("rbv2_super", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
#opt("random_search")$optimize(ins)
```

## FCNet

We first load the config:

```{r,eval=FALSE}
workdir = "/tmp/multifidelity_data/"
cfg = cfgs("fcnet", workdir = workdir)
```

this config contains our `objective` which we can use to optimize.

```{r,eval=FALSE}
ins = OptimInstanceMultiCrit$new(
  objective = cfg$get_objective(),
  terminator = trm("evals", n_evals = 10L)
)
opt("random_search")$optimize(ins)
```
