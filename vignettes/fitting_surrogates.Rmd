---
title: "Fitting Surrogates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fitting_surrogates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, eval=FALSE}
# One-time setup
library(reticulate)
conda_create(
  envname = "mlr3keras",
  packages = c("pandas", "python=3.8")
)
keras::install_keras("conda", tensorflow="2.3.1", envname="mlr3keras")
conda_install(
  envname = "mlr3keras",
  packages = c("keras2onnx", "onnxruntime"),
  pip = TRUE
)
```

```{r setup}
reticulate::use_condaenv('mlr3keras', required = TRUE)
devtools::load_all()
```


## Overview

| instance    | space   | dims | ntargets | fidelity | n\_problems |       $R^2$ |
|:------------|:--------|-----:|---------:|:---------|------------:|------------:|
| NB301       | Cat+Dep |   34 |        2 | epochs   |           1 |      0.9866 |
| LCBench     | Mix     |    7 |        6 | epoch    |          35 |      0.9820 |
| RBv2SVM     | Mix+Dep |    7 |        4 | NA       |          98 |         119 |
| RBv2rpart   | Mix     |    5 |        4 | NA       |          22 |         119 |
| RBv2aknn    | Mix     |    6 |        4 | NA       |          33 |         119 |
| RBv2glmnet  | Mix     |    3 |        4 | NA       |          56 |         119 |
| RBv2ranger  | Mix+Dep |    9 |        4 | NA       |         114 |         119 |
| RBv2xgboost | Mix+Dep |   14 |        4 | NA       |         119 |         119 |



Creating a **BenchmarkConfig**:

All benchmarks have an associated **BenchmarkConfig** that contains paths to relevant files and other configurations required.

In order to fit surrogates or to get the objective we first instantiate the **Config** object.

```{r}
workdir = paste0(path.expand("~"), "/..", "/LRZ Sync+Share/multifidelity_data/")
cfg = BenchmarkConfigNB301$new(workdir = workdir)
```

or alternatively use the sugar:

```{r}
cfg = cfgs('nb301', workdir = workdir)
```

and start fitting a surrogate:

```{r}
cfg$fit_surrogate()
```

We can adjust the NeuralNet architecture and fitting parameters by supplying a `model_config`.

```{r}
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config)
```

**NOTE** per default, models are not saved. We can enable this by supplying `overwrite = TRUE`.

The same holds for all other models:



## LCBench

```{r}
cfg = cfgs('lcbench', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config)
```

## SVM

```{r}
cfg = cfgs('rbv2_svm', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

Check the results
```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```


```{r}
save_task_ids(cfg)
```

## Ranger

```{r}
cfg = cfgs('rbv2_ranger', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

And we save the task_ids to a text file.

```{r}
save_task_ids(cfg)
```

and check whether this works

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```


## GLMNET

```{r}
cfg = cfgs('rbv2_glmnet', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## RPART

```{r}
cfg = cfgs('rbv2_rpart', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## XGBOOST

```{r, eval = FALSE}
cfg = cfgs('rbv2_xgboost', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## Aproximate KNN (aknn)

```{r, eval = FALSE}
cfg = cfgs('rbv2_aknn', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## Determining task_ids for evaluation

```{r}
map(cfgs()$keys()[4:9], function(x) {
  cfgs(x)$get_task_id_param()$levels
})
```
