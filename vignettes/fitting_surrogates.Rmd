---
title: "Fitting Surrogates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fitting_surrogates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, eval=FALSE}
# One-time setup
library(reticulate)
conda_create(
  envname = "mlr3keras",
  packages = c("pandas", "python=3.8")
)
keras::install_keras("conda", tensorflow="2.3.1", envname="mlr3keras")
conda_install(
  envname = "mlr3keras",
  packages = c("keras2onnx", "onnxruntime"),
  pip = TRUE
)
```

```{r setup}
reticulate::use_condaenv('mlr3keras', required = TRUE)
devtools::load_all()
```


Creating a **BenchmarkConfig**:

All benchmarks have an associated **BenchmarkConfig** that contains paths to relevant files and other configurations required.

In order to fit surrogates or to get the objective we first instantiate the **Config** object.

```{r}
workdir = paste0(path.expand("~"), "/..", "/LRZ Sync+Share/multifidelity_data/")
cfg = BenchmarkConfigNB301$new(workdir = workdir)
```

or alternatively use the sugar:

```{r}
cfg = cfgs('nb301', workdir = workdir)
```

and start fitting a surrogate:

```{r}
cfg$fit_surrogate()
```

We can adjust the NeuralNet architecture and fitting parameters by supplying a `model_config`.

```{r}
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config)
```

**NOTE** per default, models are not saved. We can enable this by supplying `overwrite = TRUE`.

The same holds for all other models:



## LCBench

```{r}
workdir = paste0(path.expand("~"), "/..", "/LRZ Sync+Share/multifidelity_data/")
cfg = cfgs('lcbench', workdir = workdir)
cfg$tune_surrogate()
```

```{r}
cfg = cfgs('lcbench', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```


## SVM

```{r}
cfg = cfgs('rbv2_svm', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

Check the results
```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```


```{r}
save_task_ids(cfg)
```

## Ranger

```{r}
cfg = cfgs('rbv2_ranger', workdir = workdir)
model_config = default_model_config()
model_config$epochs = 1L
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

And we save the task_ids to a text file.

```{r}
save_task_ids(cfg)
```

and check whether this works

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```


## GLMNET

```{r}
workdir = paste0(path.expand("~"), "/..", "/LRZ Sync+Share/multifidelity_data/")
cfg = cfgs('rbv2_glmnet', workdir = workdir)
cfg$tune_surrogate()
```

```{r}
cfg = cfgs('rbv2_glmnet', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## RPART

```{r}
cfg = cfgs('rbv2_rpart', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## XGBOOST

```{r, eval = FALSE}
cfg = cfgs('rbv2_xgboost', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## Aproximate KNN (aknn)

```{r, eval = FALSE}
cfg = cfgs('rbv2_aknn', workdir = workdir)
model_config = default_model_config()
cfg$fit_surrogate(model_config = model_config, overwrite = TRUE)
```

```{r}
  obj = cfg$get_objective()
  des = paradox::generate_design_random(cfg$param_set, 10)
  data = rbindlist(des$transpose(FALSE))[,names(obj$domain$params), with=FALSE]
  obj$eval_dt(data)
```

```{r}
save_task_ids(cfg)
```

## Determining task_ids for evaluation

```{r}
map(cfgs()$keys()[4:9], function(x) {
  cfgs(x)$get_task_id_param()$levels
})
```
